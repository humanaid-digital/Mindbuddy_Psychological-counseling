<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™”ìƒìƒë‹´ ì§„í–‰ì¤‘ - ë§ˆì¸ë“œë²„ë””</title>
    <!-- Jitsi Meet API -->
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .session-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .session-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .session-details {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .session-time {
            background: #fbbf24;
            color: #1e3a8a;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .participant-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        /* Video Area */
        .video-area {
            flex: 1;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1rem;
            padding: 1rem;
        }

        .main-video {
            position: relative;
            background: #2a2a2a;
            border-radius: 15px;
            overflow: hidden;
        }

        /* Jitsi Meet ì»¨í…Œì´ë„ˆ */
        #jitsi-container {
            width: 100%;
            height: 100%;
            min-height: 500px;
            border-radius: 15px;
            overflow: hidden;
        }

        /* ë¡œë”© ìƒíƒœ */
        .video-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-placeholder {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .video-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 10;
        }

        .connection-status.connected {
            background: rgba(40, 167, 69, 0.8);
        }

        .connection-status.connecting {
            background: rgba(251, 191, 36, 0.8);
        }

        .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.8);
        }

        /* Sidebar */
        .session-sidebar {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.2rem;
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.5rem;
            text-align: center;
            border: none;
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-tab.active {
            background: #fbbf24;
            color: #1e3a8a;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
        }

        /* Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            max-height: 300px;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.sent {
            background: #fbbf24;
            color: #1e3a8a;
            margin-left: auto;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
        }

        .message-sender {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.3rem;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 20px;
            background: #fbbf24;
            color: #1e3a8a;
            cursor: pointer;
        }

        /* Notes */
        .notes-area {
            height: 100%;
        }

        .notes-textarea {
            width: 100%;
            height: 300px;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: none;
            outline: none;
        }

        .notes-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Controls */
        .session-controls {
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
        }

        .control-btn.end {
            background: #dc3545;
            color: white;
            width: 80px;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ì„¸ì…˜ ì •ë³´ */
        .session-info-panel {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .session-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .session-info-item:last-child {
            margin-bottom: 0;
        }

        .session-timer {
            position: absolute;
            left: 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fbbf24;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .video-area {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .session-sidebar {
                height: 200px;
            }
            
            .self-video {
                width: 150px;
                height: 100px;
            }
        }

        @media (max-width: 768px) {
            .session-header {
                padding: 0.5rem 1rem;
            }
            
            .session-details {
                gap: 1rem;
            }
            
            .participant-info {
                display: none;
            }
            
            .video-area {
                padding: 0.5rem;
            }
            
            .self-video {
                width: 120px;
                height: 80px;
                top: 0.5rem;
                right: 0.5rem;
            }
            
            .session-controls {
                padding: 0.5rem 1rem;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="session-container">
        <!-- Header -->
        <div class="session-header">
            <div class="session-info">
                <div class="logo">ë§ˆì¸ë“œë²„ë””</div>
                <div class="session-details">
                    <div class="session-time" id="sessionTimer">45:32</div>
                    <div class="participant-info">
                        <div class="status-indicator"></div>
                        <span>ê¹€ìƒë‹´ ìƒë‹´ì‚¬</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Area -->
        <div class="video-area">
            <div class="main-video">
                <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
                <div class="connection-status connecting" id="connectionStatus">
                    ì—°ê²° ì¤‘...
                </div>
                
                <!-- Jitsi Meet ì»¨í…Œì´ë„ˆ -->
                <div id="jitsi-container">
                    <div class="video-loading" id="videoLoading">
                        <div class="loading-spinner"></div>
                        <div>í™”ìƒìƒë‹´ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">
                            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
                        </div>
                    </div>
                </div>
                
                <!-- í™”ìƒìƒë‹´ì´ ì•„ë‹Œ ê²½ìš° í‘œì‹œ -->
                <div class="video-placeholder" id="videoPlaceholder" style="display: none;">
                    <div class="video-placeholder-icon">ğŸ’¬</div>
                    <div>ìŒì„±ìƒë‹´ ì§„í–‰ì¤‘</div>
                    <div style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.8;">
                        ì±„íŒ…ì°½ì„ í†µí•´ ì†Œí†µí•˜ì„¸ìš”
                    </div>
                </div>
            </div>

            <div class="session-sidebar">
                <!-- ì„¸ì…˜ ì •ë³´ -->
                <div class="session-info-panel">
                    <div class="session-info-item">
                        <span>ìƒë‹´ì‚¬:</span>
                        <span id="counselorName">ê¹€ìƒë‹´ ìƒë‹´ì‚¬</span>
                    </div>
                    <div class="session-info-item">
                        <span>ìƒë‹´ ë°©ì‹:</span>
                        <span id="sessionMethod">í™”ìƒìƒë‹´</span>
                    </div>
                    <div class="session-info-item">
                        <span>ì§„í–‰ ì‹œê°„:</span>
                        <span id="sessionDuration">45:32</span>
                    </div>
                </div>

                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="chat">ì±„íŒ…</button>
                    <button class="sidebar-tab" data-tab="notes">ë©”ëª¨</button>
                </div>

                <div class="tab-content">
                    <!-- Chat Tab -->
                    <div id="chat-tab" class="tab-panel">
                        <div class="chat-messages">
                            <div class="message received">
                                <div class="message-sender">ê¹€ìƒë‹´ ìƒë‹´ì‚¬</div>
                                <div>ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ìƒë‹´ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</div>
                            </div>
                            <div class="message sent">
                                <div class="message-sender">ë‚˜</div>
                                <div>ë„¤, ì•ˆë…•í•˜ì„¸ìš”. ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</div>
                            </div>
                            <div class="message received">
                                <div class="message-sender">ê¹€ìƒë‹´ ìƒë‹´ì‚¬</div>
                                <div>ì˜¤ëŠ˜ì€ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</div>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="chatInput">
                            <button class="send-btn" id="sendBtn">ì „ì†¡</button>
                        </div>
                    </div>

                    <!-- Notes Tab -->
                    <div id="notes-tab" class="tab-panel" style="display: none;">
                        <div class="notes-area">
                            <textarea class="notes-textarea" placeholder="ìƒë‹´ ì¤‘ ë©”ëª¨ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”...&#10;&#10;â€¢ ì˜¤ëŠ˜ì˜ ì£¼ìš” ì£¼ì œ&#10;â€¢ ëŠë‚€ ì &#10;â€¢ ë‹¤ìŒ ìƒë‹´ì—ì„œ ë‹¤ë£° ë‚´ìš©"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="session-controls">
            <div class="session-timer" id="timerDisplay">45:32</div>
            
            <button class="control-btn end" id="endBtn" title="ìƒë‹´ ì¢…ë£Œ">
                ğŸ“
            </button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let jitsiApi = null;
        let sessionData = null;
        let sessionTimer = null;
        let sessionStartTime = Date.now();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeSession();
        });

        // ì„¸ì…˜ ì´ˆê¸°í™”
        async function initializeSession() {
            try {
                // URLì—ì„œ ì„¸ì…˜ ID ì¶”ì¶œ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì•„ì•¼ í•¨)
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId') || 'demo-session-123';
                
                // ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                sessionData = await response.json();
                
                // UI ì—…ë°ì´íŠ¸
                updateSessionInfo(sessionData.data);
                
                // í™”ìƒìƒë‹´ì¸ ê²½ìš° Jitsi Meet ì´ˆê¸°í™”
                if (sessionData.data.method === 'video' && sessionData.data.jitsiConfig) {
                    await initializeJitsiMeet(sessionData.data.jitsiConfig);
                } else {
                    // ìŒì„±ìƒë‹´ ë˜ëŠ” ì±„íŒ…ìƒë‹´ì¸ ê²½ìš°
                    showNonVideoInterface(sessionData.data.method);
                }

                // íƒ€ì´ë¨¸ ì‹œì‘
                startSessionTimer();

            } catch (error) {
                console.error('ì„¸ì…˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì„¸ì…˜ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // Jitsi Meet ì´ˆê¸°í™”
        async function initializeJitsiMeet(config) {
            try {
                const domain = config.domain;
                const options = {
                    roomName: config.roomName,
                    width: '100%',
                    height: '100%',
                    parentNode: document.getElementById('jitsi-container'),
                    configOverwrite: config.configOverwrite,
                    interfaceConfigOverwrite: config.interfaceConfigOverwrite,
                    userInfo: config.userInfo
                };

                // JWT í† í°ì´ ìˆìœ¼ë©´ ì¶”ê°€
                if (config.jwt) {
                    options.jwt = config.jwt;
                }

                // Jitsi Meet API ì´ˆê¸°í™”
                jitsiApi = new JitsiMeetExternalAPI(domain, options);

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupJitsiEventListeners();

                // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                document.getElementById('videoLoading').style.display = 'none';

            } catch (error) {
                console.error('Jitsi Meet ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('í™”ìƒìƒë‹´ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // Jitsi Meet ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupJitsiEventListeners() {
            // íšŒì˜ ì°¸ê°€ ì™„ë£Œ
            jitsiApi.addEventListener('videoConferenceJoined', () => {
                console.log('í™”ìƒìƒë‹´ ì°¸ê°€ ì™„ë£Œ');
                updateConnectionStatus('connected', 'ì—°ê²°ë¨');
            });

            // íšŒì˜ ì¢…ë£Œ
            jitsiApi.addEventListener('videoConferenceLeft', () => {
                console.log('í™”ìƒìƒë‹´ ì¢…ë£Œ');
                updateConnectionStatus('disconnected', 'ì—°ê²° í•´ì œë¨');
            });

            // ì°¸ê°€ì ì°¸ê°€
            jitsiApi.addEventListener('participantJoined', (participant) => {
                console.log('ì°¸ê°€ì ì°¸ê°€:', participant);
                addChatMessage('ì‹œìŠ¤í…œ', `${participant.displayName}ë‹˜ì´ ì°¸ê°€í–ˆìŠµë‹ˆë‹¤.`, 'system');
            });

            // ì°¸ê°€ì í‡´ì¥
            jitsiApi.addEventListener('participantLeft', (participant) => {
                console.log('ì°¸ê°€ì í‡´ì¥:', participant);
                addChatMessage('ì‹œìŠ¤í…œ', `${participant.displayName}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`, 'system');
            });

            // ì˜¤ë¥˜ ë°œìƒ
            jitsiApi.addEventListener('errorOccurred', (error) => {
                console.error('Jitsi Meet ì˜¤ë¥˜:', error);
                showError('í™”ìƒìƒë‹´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });

            // ì—°ê²° ìƒíƒœ ë³€ê²½
            jitsiApi.addEventListener('connectionStatusChanged', (status) => {
                console.log('ì—°ê²° ìƒíƒœ ë³€ê²½:', status);
                if (status === 'CONNECTION_ESTABLISHED') {
                    updateConnectionStatus('connected', 'ì—°ê²°ë¨');
                } else if (status === 'CONNECTION_FAILED') {
                    updateConnectionStatus('disconnected', 'ì—°ê²° ì‹¤íŒ¨');
                }
            });
        }

        // ë¹„í™”ìƒ ìƒë‹´ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        function showNonVideoInterface(method) {
            document.getElementById('jitsi-container').style.display = 'none';
            document.getElementById('videoPlaceholder').style.display = 'flex';
            
            const methodText = method === 'voice' ? 'ìŒì„±ìƒë‹´' : 'ì±„íŒ…ìƒë‹´';
            document.getElementById('sessionMethod').textContent = methodText;
            
            updateConnectionStatus('connected', 'ì—°ê²°ë¨');
        }

        // ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSessionInfo(data) {
            document.getElementById('counselorName').textContent = data.counselor.name;
            document.getElementById('sessionMethod').textContent = 
                data.method === 'video' ? 'í™”ìƒìƒë‹´' : 
                data.method === 'voice' ? 'ìŒì„±ìƒë‹´' : 'ì±„íŒ…ìƒë‹´';
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            statusElement.textContent = text;
        }

        // ì„¸ì…˜ íƒ€ì´ë¨¸ ì‹œì‘
        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('sessionTimer').textContent = timeString;
                document.getElementById('timerDisplay').textContent = timeString;
                document.getElementById('sessionDuration').textContent = timeString;
            }, 1000);
        }

        // ì„¸ì…˜ ì¢…ë£Œ
        async function endSession() {
            if (!confirm('ìƒë‹´ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                // Jitsi Meet ì¢…ë£Œ
                if (jitsiApi) {
                    jitsiApi.dispose();
                    jitsiApi = null;
                }

                // íƒ€ì´ë¨¸ ì •ì§€
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                }

                // ì„œë²„ì— ì„¸ì…˜ ì¢…ë£Œ ì•Œë¦¼
                if (sessionData) {
                    await fetch(`/api/sessions/${sessionData.data.sessionId}/end`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }

                // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                const userRole = localStorage.getItem('userRole') || 'client';
                window.location.href = userRole === 'counselor' ? 'counselor-dashboard.html' : 'client-dashboard.html';

            } catch (error) {
                console.error('ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:', error);
                alert('ì„¸ì…˜ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #dc3545;
                color: white;
                padding: 1rem 2rem;
                border-radius: 8px;
                z-index: 9999;
                text-align: center;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                document.body.removeChild(errorDiv);
            }, 5000);
        }

        // Tab switching
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                document.getElementById(tabName + '-tab').style.display = 'block';
            });
        });

        // Chat functionality
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage('ë‚˜', message, 'sent');
                input.value = '';
                
                // ì‹¤ì œë¡œëŠ” Socket.IOë‚˜ Jitsi Meet ì±„íŒ… APIë¥¼ í†µí•´ ì „ì†¡
                if (jitsiApi) {
                    jitsiApi.executeCommand('sendChatMessage', message);
                }
            }
        }

        function addChatMessage(sender, message, type = 'received') {
            const chatMessages = document.querySelector('.chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="message-sender">${sender}</div>
                <div>${message}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì„¸ì…˜ ì¢…ë£Œ ë²„íŠ¼
        document.getElementById('endBtn').addEventListener('click', endSession);

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (jitsiApi) {
                jitsiApi.dispose();
            }
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
        });

        // Auto-scroll chat
        const chatMessages = document.querySelector('.chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>